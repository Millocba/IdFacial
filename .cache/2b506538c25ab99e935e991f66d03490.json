{"dependencies":[{"name":"tslib","loc":{"line":1,"column":39}},{"name":"@tensorflow/tfjs-core","loc":{"line":2,"column":20}},{"name":"./common/getModelUris","loc":{"line":3,"column":29}},{"name":"./dom","loc":{"line":4,"column":30}},{"name":"./env","loc":{"line":5,"column":20}}],"generated":{"js":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.NeuralNetwork = undefined;\n\nvar _tslib = require(\"tslib\");\n\nvar _tfjsCore = require(\"@tensorflow/tfjs-core\");\n\nvar tf = _interopRequireWildcard(_tfjsCore);\n\nvar _getModelUris = require(\"./common/getModelUris\");\n\nvar _dom = require(\"./dom\");\n\nvar _env = require(\"./env\");\n\nfunction _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }\n\nvar NeuralNetwork = /** @class */function () {\n  function NeuralNetwork(_name) {\n    this._name = _name;\n    this._params = undefined;\n    this._paramMappings = [];\n  }\n  Object.defineProperty(NeuralNetwork.prototype, \"params\", {\n    get: function () {\n      return this._params;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(NeuralNetwork.prototype, \"paramMappings\", {\n    get: function () {\n      return this._paramMappings;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  Object.defineProperty(NeuralNetwork.prototype, \"isLoaded\", {\n    get: function () {\n      return !!this.params;\n    },\n    enumerable: true,\n    configurable: true\n  });\n  NeuralNetwork.prototype.getParamFromPath = function (paramPath) {\n    var _a = this.traversePropertyPath(paramPath),\n        obj = _a.obj,\n        objProp = _a.objProp;\n    return obj[objProp];\n  };\n  NeuralNetwork.prototype.reassignParamFromPath = function (paramPath, tensor) {\n    var _a = this.traversePropertyPath(paramPath),\n        obj = _a.obj,\n        objProp = _a.objProp;\n    obj[objProp].dispose();\n    obj[objProp] = tensor;\n  };\n  NeuralNetwork.prototype.getParamList = function () {\n    var _this = this;\n    return this._paramMappings.map(function (_a) {\n      var paramPath = _a.paramPath;\n      return {\n        path: paramPath,\n        tensor: _this.getParamFromPath(paramPath)\n      };\n    });\n  };\n  NeuralNetwork.prototype.getTrainableParams = function () {\n    return this.getParamList().filter(function (param) {\n      return param.tensor instanceof tf.Variable;\n    });\n  };\n  NeuralNetwork.prototype.getFrozenParams = function () {\n    return this.getParamList().filter(function (param) {\n      return !(param.tensor instanceof tf.Variable);\n    });\n  };\n  NeuralNetwork.prototype.variable = function () {\n    var _this = this;\n    this.getFrozenParams().forEach(function (_a) {\n      var path = _a.path,\n          tensor = _a.tensor;\n      _this.reassignParamFromPath(path, tensor.variable());\n    });\n  };\n  NeuralNetwork.prototype.freeze = function () {\n    var _this = this;\n    this.getTrainableParams().forEach(function (_a) {\n      var path = _a.path,\n          variable = _a.tensor;\n      var tensor = tf.tensor(variable.dataSync());\n      variable.dispose();\n      _this.reassignParamFromPath(path, tensor);\n    });\n  };\n  NeuralNetwork.prototype.dispose = function (throwOnRedispose) {\n    if (throwOnRedispose === void 0) {\n      throwOnRedispose = true;\n    }\n    this.getParamList().forEach(function (param) {\n      if (throwOnRedispose && param.tensor.isDisposed) {\n        throw new Error(\"param tensor has already been disposed for path \" + param.path);\n      }\n      param.tensor.dispose();\n    });\n    this._params = undefined;\n  };\n  NeuralNetwork.prototype.serializeParams = function () {\n    return new Float32Array(this.getParamList().map(function (_a) {\n      var tensor = _a.tensor;\n      return Array.from(tensor.dataSync());\n    }).reduce(function (flat, arr) {\n      return flat.concat(arr);\n    }));\n  };\n  NeuralNetwork.prototype.load = function (weightsOrUrl) {\n    return (0, _tslib.__awaiter)(this, void 0, void 0, function () {\n      return (0, _tslib.__generator)(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (weightsOrUrl instanceof Float32Array) {\n              this.extractWeights(weightsOrUrl);\n              return [2 /*return*/];\n            }\n            return [4 /*yield*/, this.loadFromUri(weightsOrUrl)];\n          case 1:\n            _a.sent();\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  NeuralNetwork.prototype.loadFromUri = function (uri) {\n    return (0, _tslib.__awaiter)(this, void 0, void 0, function () {\n      var weightMap;\n      return (0, _tslib.__generator)(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            if (uri && typeof uri !== 'string') {\n              throw new Error(this._name + \".loadFromUri - expected model uri\");\n            }\n            return [4 /*yield*/, (0, _dom.loadWeightMap)(uri, this.getDefaultModelName())];\n          case 1:\n            weightMap = _a.sent();\n            this.loadFromWeightMap(weightMap);\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  NeuralNetwork.prototype.loadFromDisk = function (filePath) {\n    return (0, _tslib.__awaiter)(this, void 0, void 0, function () {\n      var readFile, _a, manifestUri, modelBaseUri, fetchWeightsFromDisk, loadWeights, manifest, _b, _c, weightMap;\n      return (0, _tslib.__generator)(this, function (_d) {\n        switch (_d.label) {\n          case 0:\n            if (filePath && typeof filePath !== 'string') {\n              throw new Error(this._name + \".loadFromDisk - expected model file path\");\n            }\n            readFile = _env.env.getEnv().readFile;\n            _a = (0, _getModelUris.getModelUris)(filePath, this.getDefaultModelName()), manifestUri = _a.manifestUri, modelBaseUri = _a.modelBaseUri;\n            fetchWeightsFromDisk = function (filePaths) {\n              return Promise.all(filePaths.map(function (filePath) {\n                return readFile(filePath).then(function (buf) {\n                  return buf.buffer;\n                });\n              }));\n            };\n            loadWeights = tf.io.weightsLoaderFactory(fetchWeightsFromDisk);\n            _c = (_b = JSON).parse;\n            return [4 /*yield*/, readFile(manifestUri)];\n          case 1:\n            manifest = _c.apply(_b, [_d.sent().toString()]);\n            return [4 /*yield*/, loadWeights(manifest, modelBaseUri)];\n          case 2:\n            weightMap = _d.sent();\n            this.loadFromWeightMap(weightMap);\n            return [2 /*return*/];\n        }\n      });\n    });\n  };\n  NeuralNetwork.prototype.loadFromWeightMap = function (weightMap) {\n    var _a = this.extractParamsFromWeigthMap(weightMap),\n        paramMappings = _a.paramMappings,\n        params = _a.params;\n    this._paramMappings = paramMappings;\n    this._params = params;\n  };\n  NeuralNetwork.prototype.extractWeights = function (weights) {\n    var _a = this.extractParams(weights),\n        paramMappings = _a.paramMappings,\n        params = _a.params;\n    this._paramMappings = paramMappings;\n    this._params = params;\n  };\n  NeuralNetwork.prototype.traversePropertyPath = function (paramPath) {\n    if (!this.params) {\n      throw new Error(\"traversePropertyPath - model has no loaded params\");\n    }\n    var result = paramPath.split('/').reduce(function (res, objProp) {\n      if (!res.nextObj.hasOwnProperty(objProp)) {\n        throw new Error(\"traversePropertyPath - object does not have property \" + objProp + \", for path \" + paramPath);\n      }\n      return { obj: res.nextObj, objProp: objProp, nextObj: res.nextObj[objProp] };\n    }, { nextObj: this.params });\n    var obj = result.obj,\n        objProp = result.objProp;\n    if (!obj || !objProp || !(obj[objProp] instanceof tf.Tensor)) {\n      throw new Error(\"traversePropertyPath - parameter is not a tensor, for path \" + paramPath);\n    }\n    return { obj: obj, objProp: objProp };\n  };\n  return NeuralNetwork;\n}();\nexports.NeuralNetwork = NeuralNetwork;\n//# sourceMappingURL=NeuralNetwork.js.map"},"hash":"5db40e1f512d09394d6f7687cbcff31c"}